# =============================================================================
# Azure IPAM - Docker Compose Production Deployment
# =============================================================================
#
# Usage:
#   1. Copy .env.example to .env and configure your Azure credentials
#   2. Build: docker-compose build
#   3. Run: docker-compose up -d
#   4. Access: http://localhost:8080
#
# =============================================================================

services:
  # -------------------------------------------------------------------------
  # Azure Functions API
  # -------------------------------------------------------------------------
  api:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.api
    container_name: azure-ipam-api
    restart: unless-stopped
    ports:
      - "7071:7071"
    environment:
      # Azure Authentication (Service Principal)
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
      # Optional: Filter to specific subscriptions
      - AZURE_SUBSCRIPTION_IDS=${AZURE_SUBSCRIPTION_IDS:-}
      # Azure Functions settings
      - AzureWebJobsStorage=${AZURE_STORAGE_CONNECTION:-UseDevelopmentStorage=true}
      - FUNCTIONS_WORKER_RUNTIME=node
    networks:
      - ipam-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7071/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -------------------------------------------------------------------------
  # React Frontend (served via Nginx)
  # -------------------------------------------------------------------------
  frontend:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.frontend
      args:
        - VITE_AZURE_TENANT_ID=${VITE_AZURE_TENANT_ID}
        - VITE_AZURE_CLIENT_ID=${VITE_AZURE_CLIENT_ID}
        - VITE_API_BASE_URL=/api
    container_name: azure-ipam-frontend
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Runtime configuration (injected at startup)
      - VITE_AZURE_TENANT_ID=${VITE_AZURE_TENANT_ID}
      - VITE_AZURE_CLIENT_ID=${VITE_AZURE_CLIENT_ID}
      - VITE_API_BASE_URL=/api
      - API_URL=http://api:7071/api
    depends_on:
      api:
        condition: service_healthy
    networks:
      - ipam-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -------------------------------------------------------------------------
  # Azurite (Azure Storage Emulator) - Optional for local development
  # -------------------------------------------------------------------------
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    container_name: azure-ipam-azurite
    restart: unless-stopped
    ports:
      - "10000:10000"  # Blob
      - "10001:10001"  # Queue
      - "10002:10002"  # Table
    volumes:
      - azurite-data:/data
    command: "azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 -l /data --debug /data/debug.log"
    networks:
      - ipam-network
    profiles:
      - local  # Only start with: docker-compose --profile local up

networks:
  ipam-network:
    driver: bridge

volumes:
  azurite-data:
